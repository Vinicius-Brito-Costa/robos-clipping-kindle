<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event)" style="background-color: blueviolet; color: white; height: 200px">
        <p>Drag your 'My Clippings.txt' file here.</p>
    </div>
    <script>
        async function uploadParts(slices){
            let stop = false;
            return await slices.forEach(async (slice, index) => {
                let fileName = "biruleibe-" + slices.length + "-" + index
                console.log(fileName)
                fr = new FileReader();
                fr.onload = res => {
                    if(!stop){
                        let options = {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json;charset=utf-8"
                            },
                            body: JSON.stringify({
                                token: fileName,
                                clippings: res.target.result
                            })
                        }
                        return fetch("http://localhost:8080/robo/api/v1/exportMulti?command=download", options)
                        .then(res => {
                            if(res.ok){
                                return res.text()
                            }
                            console.log("Errou!!!")
                            console.log(res);
                        })
                        .then(res => console.log(res));
                    }
                };
                return await fr.readAsText(slice);
            })
        }

        async function dropHandler(event){
            event.preventDefault()

            if (event.dataTransfer.items) {
                if (event.dataTransfer.items[0].kind === 'file') {
                    
                    var file = event.dataTransfer.items[0].getAsFile();
                    let multiPart = [file]//sliceFile(file, Math.round(file.size / 1000000))
                    await uploadParts(multiPart)
                }
              }
              return true;
        }
        function dragOverHandler(ev) {
            ev.preventDefault();
        }

        function readerHandler(event){
            let result = event.currentTarget.result;
            download(result);
        }

        /**
        * @param {File|Blob} - file to slice
        * @param {Number} - chunksAmount
        * @return {Array} - an array of Blobs
        **/
        function sliceFile(file, chunksAmount) {
            var byteIndex = 0;
            var chunks = [];
            
            for (var i = 0; i < chunksAmount; i += 1) {
                var byteEnd = Math.ceil((file.size / chunksAmount) * (i + 1));
                chunks.push(file.slice(byteIndex, byteEnd, "text/plain"));
                byteIndex += (byteEnd - byteIndex);
            }
            return chunks.length < 1 ? [file] : chunks;
        }
    </script>
</body>
</html>