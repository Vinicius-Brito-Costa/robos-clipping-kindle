<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <button onclick="activateCommand('download')">DOWNLOAD-COMMAND</button>
    <button onclick="activateCommand('download-docx')">DOCX-COMMAND</button>
    <div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event)" style="background-color: blueviolet; color: white; height: 200px">
        <p>Drag your 'My Clippings.txt' file here.</p>
    </div>
    <script>
        let command = "";
        function activateCommand(comm){
            command = comm;
            console.log(command);
        }
        async function upload(file){
            let fileName = "biruleibe-" + file.length + "-test"
            console.log(fileName)
            fr = new FileReader();
            fr.onload = res => {
                let options = {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json;charset=utf-8"
                    },
                    body: JSON.stringify({
                        token: fileName,
                        clippings: res.target.result
                    })
                }
                console.log(options)
                fetch("http://localhost:8080/robo/api/v1/export?command=" + command, options)
                .then(res => {
                    if(res.ok){
                        return res.json()
                    }
                    console.log("Errou!!!")
                    console.log(res);
                })
                .then(res => {
                    if(command == "download"){
                        let books = {};
                        res.data.result.forEach(book => {
                            books[book.title] = book.clippings
                        })

                        download(new Blob([JSON.stringify(books)], {type: "application/json"}), "json");
                    }
                    else if(command == "download-docx"){
                        download(new Blob([res.data.result], {type: "text/plain"}), "docx");
                    }
                });
            };
            fr.readAsText(file)
        }

        async function dropHandler(event){
            event.preventDefault()

            if (event.dataTransfer.items) {
                if (event.dataTransfer.items[0].kind === 'file') {
                    
                    var file = event.dataTransfer.items[0].getAsFile();
                    await upload(file)
                }
              }
              return true;
        }
        function dragOverHandler(ev) {
            ev.preventDefault();
        }
        function download(blob, extension){
            let link = document.createElement("a")
            link.href = window.URL.createObjectURL(blob);
            link.target = "_blank";
            link.download = "My Clippings." + extension;
            link.click();
        }
    </script>
</body>
</html>